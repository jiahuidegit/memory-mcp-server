// Prisma Schema for Context Memory System (PostgreSQL)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 记忆表
model Memory {
  /// 主键：记忆唯一标识
  id String @id @default(cuid())

  /// 元信息
  projectId String
  sessionId String?
  timestamp DateTime @default(now())
  type      String   // decision, solution, config, code, error, session
  tags      String[] @default([])
  version   Int      @default(1)

  /// 内容
  summary String
  data    Json @default("{}")

  /// 关系
  replaces    String[] @default([])
  relatedTo   String[] @default([])
  impacts     String[] @default([])
  derivedFrom String?

  /// 上下文（特定类型的额外数据）
  context Json?

  /// 检索字段
  keywords String[] @default([])
  fullText String

  /// 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// 索引
  @@index([projectId])
  @@index([sessionId])
  @@index([type])
  @@index([timestamp(sort: Desc)])
  @@index([projectId, type])
  @@index([projectId, timestamp(sort: Desc)])
  @@index([projectId, type, timestamp(sort: Desc)])
  @@map("memories")
}

/// 项目组表 - 关联相关项目
model ProjectGroup {
  /// 主键：项目组唯一标识
  id String @id @default(cuid())

  /// 项目组名称
  name String @unique

  /// 项目列表（JSON 数组存储）
  projects String[] @default([])

  /// 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("project_groups")
}

/// 记忆关联表 - 存储记忆之间的关系
model MemoryRelation {
  /// 主键
  id String @id @default(cuid())

  /// 源记忆 ID
  sourceId String

  /// 目标记忆 ID
  targetId String

  /// 关系类型：relatedTo, replaces, impacts, derivedFrom
  relationType String

  /// 关系类型（冗余字段，用于兼容）
  type String?

  /// 关系置信度 (0-1)
  confidence Float @default(1.0)

  /// 是否自动生成
  isAutoGenerated Boolean @default(false)

  /// 关系原因/描述
  reason String?

  /// 时间戳
  createdAt DateTime @default(now())

  /// 索引
  @@index([sourceId])
  @@index([targetId])
  @@index([relationType])
  @@index([type])
  @@index([isAutoGenerated])
  @@unique([sourceId, targetId, relationType])
  @@map("memory_relations")
}
