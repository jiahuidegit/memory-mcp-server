// Prisma Schema for Context Memory System (PostgreSQL)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 记忆表
model Memory {
  /// 主键：记忆唯一标识
  id String @id @default(cuid())

  /// 元信息
  projectId String
  sessionId String?
  timestamp DateTime @default(now())
  type      String   // decision, solution, config, code, error, session
  tags      String[] @default([])
  version   Int      @default(1)

  /// 内容
  summary String
  data    Json @default("{}")

  /// 关系
  replaces    String[] @default([])
  relatedTo   String[] @default([])
  impacts     String[] @default([])
  derivedFrom String?

  /// 上下文（特定类型的额外数据）
  context Json?

  /// 检索字段
  keywords String[] @default([])
  fullText String

  /// 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// 索引
  @@index([projectId])
  @@index([sessionId])
  @@index([type])
  @@index([timestamp(sort: Desc)])
  @@index([projectId, type])
  @@index([projectId, timestamp(sort: Desc)])
  @@index([projectId, type, timestamp(sort: Desc)])
  @@map("memories")
}

/// 项目组表 - 关联相关项目
model ProjectGroup {
  /// 主键：项目组唯一标识
  id String @id @default(cuid())

  /// 项目组名称
  name String @unique

  /// 项目列表（JSON 数组存储）
  projects String[] @default([])

  /// 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("project_groups")
}

/// 记忆关系表 - 存储自动/手动建立的记忆关联
model MemoryRelation {
  id              String   @id @default(cuid())
  sourceId        String   // 源记忆ID
  targetId        String   // 目标记忆ID
  type            String   // replaces | relatedTo | impacts
  confidence      Float    @default(1.0)  // 置信度 0-1（自动关联用）
  isAutoGenerated Boolean  @default(false)  // 是否自动生成
  reason          String?  // 关联原因说明
  createdAt       DateTime @default(now())

  @@unique([sourceId, targetId, type])  // 防止重复关系
  @@index([sourceId])
  @@index([targetId])
  @@index([type])
  @@map("memory_relations")
}
